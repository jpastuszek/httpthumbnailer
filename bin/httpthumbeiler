#!/usr/bin/ruby

require 'sinatra'
require 'RMagick'

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))
require 'thumbnailer'
require 'thumbnail_specs'

set :port, 3123
set :bind, 'localhost'
set :environment, 'production'
set :server, ['mongrel']
set :lock, true
set :boundary, "thumnail image data"

thumbnailer = Thumbnailer.new

thumbnailer.method('crop') do |image, spec|
	image.resize_to_fill(spec.width, spec.height)
end

get '/' do
	puts 'hello'
end

put %r{/thumbnail/([^/]*)/([^/]*)/([^/]*)/(.*)} do |id, pw, ph, specs|
	image = thumbnailer.load(id, request.body)
	thumbnail_specs = ThumbnailSpecs.from_uri(specs)

	status 200
	headers "Content-Type" => "multipart/mixed; boundary=\"#{settings.boundary}\""
	stream do |out|
		thumbnail_specs.each do |ts|
			puts "Thumbnailing: #{ts}"

			out << "--#{settings.boundary}\n"
			out << "Content-type: image/jpeg\n\n"
			out << thumbnailer.thumbnail(id, ts).to_blob do |inf|
				inf.format = 'JPEG'
			end
		end
		out << "--#{settings.boundary}--"
	end
end

